/*
 * Copyright 2025 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

rule mtrends_2025_unc5221_ivanti_exploit_cve_2024_21887 {
  meta:
    author = "Google Cloud Security"
    description = "Detects exploitation attempts of Ivanti Connect Secure VPN vulnerabilities CVE-2023-46805 and CVE-2024-21887, associated with threat actor UNC5221 as mentioned in M-Trends 2025."
    rule_id = "mr_b1a2c3d4-e5f6-7890-1234-567890abcdef"
    rule_name = "M-Trends 2025 UNC5221 Ivanti Exploit"
    mitre_attack_tactic = "TA0001"
    mitre_attack_technique = "T1190"
    type = "alert"
    data_source = "network http logs"
    severity = "Critical"
    priority = "Critical"
    reference = "https://services.google.com/fh/files/misc/m-trends-2025-en.pdf"

  events:
    $http.metadata.event_type = "NETWORK_HTTP"
    re.regex($http.network.http.url, `.*/api/v1/totp/user-backup-code/\\.\\./\\.\\./(system/maintenance/archiving/cloud-server-test-connection|license/keys-status)`)

  outcome:
    $risk_score = 100
    $source_ip = array_distinct($http.principal.ip)
    $target_hostname = array_distinct($http.target.hostname)
    $url = array_distinct($http.network.http.url)
    $user_agent = array_distinct($http.network.http.user_agent)

  condition:
    $http
}
